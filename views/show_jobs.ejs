<!DOCTYPE html>
<style>
  #map {
    width: 100%;
    height: 500px;
  }
</style>

<div id="main">
  <div id="map"></div>
  <button id="finish">Finished</button>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script src="http://maps.google.com/maps/api/js?sensor=false" 
          type="text/javascript"></script>

<script type="text/javascript">
 
  var dbTaskResult = '<%- JSON.stringify(dbTaskResult) %>'.slice(2, -2);
  var taskArray = dbTaskResult.split("},{");
  var locations = taskArray;
  for (var i = 0; i < taskArray.length; i++){
    taskArray[i] = taskArray[i].split(",");
    //id, title, employer, employee, description, longitude, latitude, status, payment
    locations[i] = [taskArray[i][0].split(':')[1].slice(1, -1),  //id
                        taskArray[i][1].split(':')[1].slice(1, -1), //title
                        taskArray[i][2].split(':')[1].slice(1, -1), //employer
                        taskArray[i][3].split(':')[1].slice(1, -1), //employee
                        taskArray[i][4].split(':')[1].slice(1, -1), //desc
                        taskArray[i][5].split(':')[1].slice(1, -1), //longitude
                        taskArray[i][6].split(':')[1].slice(1, -1), //latitude 
                        taskArray[i][7].split(':')[1].slice(1, -1), //status
                        taskArray[i][8].split(':')[1].slice(1, -1),]; //payment
  }

  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 16,
    center: new google.maps.LatLng(41.311177, -72.925767),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });

  var infowindow = new google.maps.InfoWindow({
      content: " "
    });// show information of each location

  function acceptTask(id) {
    //alert(id);
    var data = {"id":id,"employee":"test_employee"};
    $.ajax({
            type: 'POST',
            data: JSON.stringify(data),
            url: '/accept_job',
            contentType: "application/json"
        }).done(function( msg ) {       
            alert(msg);
        });
  }
  
  // create pin for each location
  for (var i = 0; i < locations.length; i++) {  
    var marker = new google.maps.Marker({
      position: new google.maps.LatLng(locations[i][5], locations[i][6]),
      map: map
    });

    google.maps.event.addListener(marker, 'mouseover', (function(marker, i) {

      var content =  ["<p>Task Name: " + locations[i][1] + "</p>" +
        "<p>Task Poster: " + locations[i][2] + "</p>" +
        "<p>Description: " + locations[i][4] + "</p>" +
        "<p>Compensation: " + locations[i][8] + "</p>" +
        "<button onClick='acceptTask(\"" + locations[i][0] + "\")'>Accept Task</button>"].join("");

      return function() {
        infowindow.setContent(content);
        infowindow.open(map, marker);
      }
    })(marker, i));
  } 

</script>